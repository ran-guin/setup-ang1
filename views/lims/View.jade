extends ./../customize/privateLayout
block content

  if !fields
    - fields = [];
  if !view
    - view = data

  - var config = {};
  - config.view = view;
  - config.id  = id;
  - config.fields = fields;
  - config.pick = pick;
  - config.data = data;
  - config.file = file;
  - config.excel = excel;

  if view 
    - view_id = view_id || view.id
    - tables = view.tables
    - fields = fields || view.fields

  - var init = "initialize(" + JSON.stringify(config) + ")";

  div.container
    p &nbsp;
    a(href="/View/edit/#{view_id}" ) 
        button.btn.btn-primary(type='button') Edit View

    span &nbsp; &nbsp;
  
    a(href="/views" ) 
        button.btn.btn-danger(type='button') Return to List of Views
    hr 

    div(ng-app='myApp' ng-cloak=1)
      div(ng-controller="SharedController" ng-init="include_all=1")
        div(ng-controller="LIMSController")
          div(ng-controller='ViewController' ng-init="#{init}")
            form(role='form' method='post' action="/view/generate" enctype='form-data')
                input(type='hidden' ng-model="form.view_id" name='view_id' value="#{config.id}")
                input(type='hidden' name='generate' value='1')
                
                include ./../core/errorAngularMsg.jade
               
                div.view-section
                    div.view-overview
                        if title
                            h3 #{title}
                        p
                            - name = view.name;
                            - id   = view.id;
                            - tables = view.tables
                            - fields = view.fields
                            - desc  = view.description
                            - active = view.active
                            - attributes = view.attributes || []

                        h4 #{name}
                        //- b From Tables: #{tables}
                        p #{desc}

                    hr
                    
                    div(ng-show='data')
                        b Query: 
                        i.text-danger {{query}}

                    div.navbar-right(ng-show="!showOptions")
                        button.btn.btn-sm.btn-warning(ng-click="showOptions=true;" onclick='return false;') Revise Search Criteria
 
                    div.search-options(ng-show="showOptions")
                        span.navbar-right
                            button.btn.btn-sm.btn-danger(ng-show="data" ng-click="showOptions=false;" onclick='return false;') Hide Search Criteria
                        h3 Search Options:

                        if fields
                            table.table.table-bordered
                                tr.text-info
                                    td  
                                        b Show
                                        span &nbsp; &nbsp;
                                        i.fa.fa-expand(ng-show="!showAll" ng-click="showAll=1")
                                        i.fa.fa-compress(ng-show="showAll" ng-click="showAll=0")
                                    td  
                                        b Field
                                    td  
                                        b Search Condition
                                    //- td  
                                    //-     b Group by
                                    td
                                        b Separate Tab/Layer 

                                each field in fields.split(/,\s*/)
                                    - var fp = field.match(/(.*) AS (.*)/i)
                                    - var prompt = field
                                    - var fld = field
                                    if fp && fp.length
                                        - fld = fp[1]
                                        - prompt = fp[2]

                                    tr(ng-show="form.show['#{prompt}'] || showAll")
                                        td
                                            input(type='checkbox' ng-model="form.show['#{prompt}']" ng-click="updateList('show','#{prompt}')" name='fields')
                                        td 
                                            span(data-toggle='tooltip' title='#{fld}') #{prompt}

                                        if (attributes && attributes.indexOf(fld) >= 0)
                                            td  
                                                //- Attributes are not auto-included, so add to field list if condition supplied here... 
                                                textarea.form-control(rows=1 ng-model="form.search['#{fld}.Attribute_Value']" ng-change="addAtt('#{fld}')" name="search#{fld}")
                                        else 
                                            td 
                                                textarea.form-control(rows=1 ng-model="form.search['#{fld}']" name="search#{fld}")
                                        //- td
                                        //-     input(type='checkbox' ng-model="form.groupBy['#{fld}']" ng-click="updateList('groupBy','#{fld}')" name='group')
                                        td
                                            input(type='radio' name='layer' ng-model="form.layer" value="#{fld}" ng-disabled="!form.show['#{prompt}']")

                        input.form-control(ng-model='form.condition' placeholder='-- optional additional condition --')
                        p &nbsp;  
                        b Show Fields: &nbsp; &nbsp;
                        b.text-success {{show.join(', ')}}                        
                        //- br
                        //- b Group by: &nbsp; &nbsp;
                        //- b.text-success {{groupBy.join(', ')}}
                        br
                        b Layer results by: &nbsp; &nbsp;
                        b.text-success {{form.layer}}
                        p
                        i Note: Re-select items as required to reorder:  items will be added in order selected

                        p &nbsp;
                        div(style='display:flex; flex-direction:row')
                            button.btn.btn-primary(type='button' ng-click="generate()") Generate Results
                            span &nbsp; &nbsp; 
                            input(type='text' style="flex:1" placeholder=' i-- optional filename -- (defaults to user + timestamp) ' ng-model='filename')    

                    hr
                    span.results-section(ng-show='data')
                        h3 Results:
                        span.results-section(ng-show='!showData')
                            button.btn.btn-success(ng-click="showData=true;" onclick='return false;') Found {{data.length}} record(s)
                            span &nbsp; &nbsp; &nbsp;
                        span(ng-show="showData")
                            button.btn.btn-danger(ng-click="showData=false" onclick='return false;') Hide Results
                            span &nbsp; &nbsp; &nbsp;

                    span(ng-show="excel && excel.file")
                        a(href="/download?file={{excel.file}}")
                            button.btn.btn-success(type='button') Download Results as Excel File
                            b &nbsp; &nbsp; [{{excel.stats.size}} kB];
 
                    span(ng-show="data && data.length && showData")
                        p &nbsp;
                        table.table(style='background-color: lightyellow;')
                            tr
                                td(ng-repeat="(i,f) in data[0]" style='background-color:grey; color: white') 
                                    b {{i}}                               
                            tr(ng-repeat="record in data")
                                td(ng-repeat="(j,fj) in record") {{fj}}             

      
