extends ./../privateLayout
block content

  div.container

    - var config = { steps : Steps, samples: Samples };
    - var init = "initialize(" + JSON.stringify(config) + ")";

    - flds = fields || []; // ['FK_Equipment__ID', 'FK_Solution__ID', 'Solution_Qty', 'Solution_Qty_Units', 'Transfer_Qty', 'Transfer_Qty_Units', 'Thaw_Time', 'Prep_Comments'];
    - units = { 'Solution_Qty' : 'Solution_Qty_Units', 'Transfer_Qty' : 'Transfer_Qty_Units'};
    - aliases = { 'FK_Equipment__ID' : 'Equip', 'FK_Solution__ID' : 'Sol' }
    - attributes = attributes || {}; // {'Thaw_Time' : 'integer' }

    hr
    div(ng-app='myApp')
      
      div(ng-controller="CommonController")
        div(ng-controller='ProtocolController' ng-init="#{init}" ngcloak)
          h5 Active Samples: {{N}} x Matrix Data Tubes
            div.navbar.navbar-right 
              b {{user}} &nbsp;
              span {{ timestamp }}
          hr

          h3 {{Step.Protocol_Step_Name}} &nbsp;
            span(ng-show="Step.Protocol_Step_Instructions")
              a(href='#' onclick="return false;" data-toggle="popover" data-trigger="focus" title="Instructions" data-content="{{Step.Protocol_Step_Instructions}}")
                i.fa.fa-question-circle
              span &nbsp;

          h4(style="color:red") {{ Step.Protocol_Step_Message }} [ {{stepNumber}} / {{steps}}]

          hr
           
          form.form-horizontal(role="form" data-toggle="validator" method='post' action="/completed-step")
            div(ng-show='errMsg')
              div.col-sm-2 &nbsp;
              div.col-sm-10
                table
                  tr
                    td(style='background-color:#faa')
                      b Error: {{ errMsg }}
            - prompted = {};
            - options = ['ml', 'ul', 'nl', 'pl'];

            div(ng-show="SplitTracking")
              div.col-sm-2 &nbsp;
              div.col-sm-10
                b Note: Expanding lists in: &nbsp;
                label
                  input(type='radio' value = 'Serial' ng-model="split_mode" ng-click="reset_Split_mode()") 
                  b &nbsp; Serial &nbsp;
                label
                  input(type='radio' value = 'Parallel' ng-model="split_mode" ng-click="reset_Split_mode()")
                  b &nbsp; Parallel &nbsp;
                span &nbsp; [ eg : 
                  b {{ splitExample }}
                  span ]



            each field in flds
              - fld = field.replace('*','');
              - alias = aliases[fld] || fld;
              - fType = 'text';

              if (fld != field)
                - alias = alias + '*';

              div(ng-show="Show['#{fld}']")
                div.form-group
                  if attributes[fld]
                    - fType = attributes[fld];

                  if fld == 'Split'
                    label.col-sm-2.control-label(for='#{fld}') Split x:
                    div.col-sm-10
                      input(type='text' ng-model="Split") 

                    - prompted[fld] = 1;

                  else if fld == 'FK_Solution__ID'
                    label.col-sm-2.control-label(for='#{fld}') Sol/Reagent:
                    div.col-sm-4
                      input.form-control(type='text', placeholder = "-- Scan --" id = '#{fld}' ng-model='#{fld}' ng-blur="splitField('#{fld}')") 
                    div.col-sm-3
                      input.form-control(type='text', placeholder = " -- Qty --" id='Solution_Qty' ng-model='Solution_Qty' ng-blur="splitField('Solution_Qty')") 
                    div.col-sm-3
                      // *** Generate Dropdown for ENUM Values *** //
                      div.dropdown
                          button.btn.btn-default.dropdown-toggle(type='button' data-toggle='dropdown' id = 'Solution_Qty_Units') Units &nbsp;
                              span.caret
                          ul.dropdown-menu
                              each opt,j in options
                                  li 
                                      a(href='#' onclick='return false;') #{j} : #{opt}

                    - prompted[fld]=1;
                    - prompted['Solution_Qty']=1;
                    - prompted['Solution_Qty_Units']=1;

                  else if units[fld] && ! prompted[fld]
                    // non special fields with units (eg attributes with units...)
                    - prompted[fld] = 1
                    label.col-sm-2.control-label(for='#{fld}') #{alias}:
                    div.col-sm-8
                      input.form-control(type='integer', placeholder = "-- Scan " + alias + '--' id='#{fld}' ng-blur="splitField('#{fld}')" ng-model='#{fld}')
                      div.help-block.with-errors(style='color:red' ng-model="#{fld}_errors") {{ #{fld}_errors }}

                    - fld = units[fld];
                    - prompted[fld] = 1;
                    div.col-sm-2
                      // *** Generate Dropdown for Units *** //
                      div.dropdown
                          button.btn.btn-default.dropdown-toggle(type='button' data-toggle='dropdown') Units &nbsp;
                              span.caret
                          ul.dropdown-menu
                              each opt,j in options
                                  li 
                                      a(href='#' onclick='return false;') #{opt}

                  else if fld == 'Prep_Comments' 
                    // non splittable field 
                    div.form-group
                      label.col-sm-2.control-label(for='#{fld}') #{alias}
                      div.col-sm-10
                        if (fld == field)
                          input.form-control(type='#{fType}'  pattern=".*" maxlength="15" placeholder = "Enter " + alias id='#{fld}' ng-model='#{fld}' default='' force=1)
                        else 
                           input.form-control(type='#{fType}' pattern="^[_A-z0-9]{1,}$" maxlength="15" placeholder = "Enter " + alias id='#{fld}' ng-model='#{fld}'  default='' force=1 )

                        div.help-block.with-errors(style='color:red' ng-model="#{fld}_errors") {{ #{fld}_errors }}  
                  else if ! prompted[fld]
                    // non special fields without units 
                    div.form-group
                      label.col-sm-2.control-label(for='#{fld}') #{alias}
                      div.col-sm-10
                        if (fld == field)
                          input.form-control(type='#{fType}' ng-blur="splitField('#{fld}')" pattern=".*" maxlength="15" placeholder = "Enter " + alias id='#{fld}' ng-model='#{fld}' default='' force=1)
                        else 
                           input.form-control(type='#{fType}'  ng-blur="splitField('#{fld}')" required pattern="^[_A-z0-9]{1,}$" maxlength="15" placeholder = "Enter " + alias id='#{fld}' ng-model='#{fld}'  default='' force=1 )

                        div.help-block.with-errors(style='color:red' ng-model="#{fld}_errors") {{ #{fld}_errors }}
                  else 
                    b unrecognized: {{fld}}

            hr
            div.form-group
              div.col-sm-2 &nbsp;
              div.col-sm-3
                button.btn.btn-success(type='button' ng-click="complete('Completed')" ng-disabled="formDisabled") Completed Step
              div.col-sm-2
                button.btn.btn-warning(type='submit' ng-click="complete('Skipped')") Skip Step
              div.col-sm-2
                button.btn.btn-danger(type='submit' ng-click="complete('Failed')") Failed Step
              div.col-sm-3
                button.btn.btn-primary(type='button' ng-click="repeat()" ng-disable="Step.Repeatable") Repeat Previous Step
              div.col-sm-12
                div.help-block.with-errors

            hr
            
            input(type='hidden' id='ids' value='2,4,6,8')
            input(type='hidden' id='target-format' value='3')
            input(type='hidden' id='target-wells' value='A01,B01,C01,D01')
            input(type='hidden' id='source-wells' value='')


          h3(ng-show="debug || 1") Debugging 

            button.btn.primary(type='button' ng-click="back()" ng-disabled='stepNumber <= 1') BACK
            span &nbsp;
            button.btn.btn-primary(type='button' ng-click="forward()" ng-disabled="stepNumber >= steps") FWD

            h5 Details: {{ Step }}
            h5 Samples: {{ Samples }}
            h5 Input: {{ input }}
            h5 Show: {{ Show }}
            h5 Fields: #{ JSON.stringify(flds) }
            h5 Attributes: #{JSON.stringify(attributes)}

          hr
 


         
